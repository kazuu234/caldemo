# Discord認証システム - テストシナリオ

## 🔐 認証フローの確認

### シナリオ1: 初回訪問（未認証）
1. ブラウザの開発者ツールを開く
2. Application > Local Storage を開く
3. `travel_app_auth_user` キーを削除（存在する場合）
4. ページをリロード
5. **期待される動作:**
   - アプリは通常通り表示される
   - ヘッダーに「ログイン」ボタンが表示される
   - 予定の閲覧は可能

### シナリオ2: ログイン
1. ヘッダーの「ログイン」ボタンをクリック
2. Discord認証ダイアログが表示される
3. 「田中」で検索
4. 「田中太郎」を選択
5. 「DMを送信」をクリック
6. 「テスト: 認証を完了」をクリック
7. **期待される動作:**
   - トースト通知「ようこそ、田中太郎さん！」が表示される
   - ダイアログが閉じる
   - ヘッダーにユーザーアバターが表示される
   - LocalStorageに認証情報が保存される

### シナリオ3: 自動ログイン（永続化の確認）
1. 認証済みの状態でページをリロード
2. **期待される動作:**
   - 自動的にログイン状態になる
   - ヘッダーにユーザーアバターが表示される
   - 認証ダイアログは表示されない

### シナリオ4: 予定追加（認証済み）
1. 「追加」ボタンをクリック
2. 予定追加画面が表示される
3. **期待される動作:**
   - 名前フィールドに認証ユーザー名が自動入力される
   - 名前フィールドは無効化（グレーアウト）される
   - 「認証済みユーザー名が自動入力されています」と表示される

### シナリオ5: 予定追加（未認証）
1. ログアウト状態で「追加」ボタンをクリック
2. **期待される動作:**
   - トースト通知「ログインすると予定管理が便利になります」が表示される
   - 「ログイン」アクションボタンが表示される
   - 予定追加画面は表示される（ログインなしでも追加可能）

### シナリオ6: ユーザープロフィール表示
1. ヘッダーのユーザーアバターをクリック
2. **期待される動作:**
   - ドロップダウンメニューが表示される
   - ユーザー名とDiscordタグが表示される
   - 「ログアウト」メニューが表示される

### シナリオ7: ログアウト
1. ユーザーアバターをクリック
2. 「ログアウト」をクリック
3. **期待される動作:**
   - トースト通知「ログアウトしました」が表示される
   - ヘッダーに「ログイン」ボタンが表示される
   - LocalStorageから認証情報が削除される
   - 予定追加時に名前フィールドが編集可能になる

### シナリオ8: Discord DM認証（URL トークン）
1. ブラウザのURLバーに `?auth_token=test123456789` を追加してアクセス
2. **期待される動作:**
   - 認証トークンが検証される
   - トースト通知「ようこそ、田中太郎さん！」が表示される
   - URLからトークンが削除される
   - 自動的にログイン状態になる

## 🔧 LocalStorage の確認

### 認証情報の構造
```json
{
  "id": "123456789012345678",
  "username": "田中太郎",
  "discordId": "123456789012345678",
  "discordTag": "田中太郎#1234",
  "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=Tanaka",
  "authenticatedAt": "2025-10-29T12:34:56.789Z"
}
```

### LocalStorageキー
- **キー名:** `travel_app_auth_user`
- **データ形式:** JSON文字列

## 🚀 Django統合時の移行ポイント

### 現在（フロントエンドのみ）
- **認証方式:** localStorage
- **データ:** クライアント側に保存
- **セキュリティ:** テスト用モック

### 将来（Django統合後）
- **認証方式:** Django Session + HttpOnly Cookie
- **データ:** サーバー側で管理
- **セキュリティ:** CSRF保護、セッション管理

### 移行時の変更箇所
1. `utils/auth.ts`
   - `setAuthUser()` → Django API `/api/auth/login/`
   - `getAuthUser()` → Django API `/api/auth/me/`
   - `clearAuthUser()` → Django API `/api/auth/logout/`

2. Discord Bot連携
   - `searchDiscordUsers()` → Django API `/api/discord/search/`
   - `requestDiscordAuth()` → Django API `/api/discord/request-auth/`
   - `verifyAuthToken()` → Django API `/api/discord/verify-token/`

3. セッション管理
   - Cookie: `sessionid` (HttpOnly, Secure)
   - CSRF Token: `csrftoken`
   - 認証確認: `credentials: 'include'` でAPIリクエスト

## 📝 メモ

### テスト用モックユーザー
- 田中太郎 (#1234)
- 佐藤花子 (#5678)
- 鈴木一郎 (#9012)
- その他17名（`utils/auth.ts` 参照）

### 検索機能
- **前方一致:** 「田」→ 田中太郎, たなか
- **部分一致:** 「Travel」→ TravelLover, TokyoTraveler
- **大文字小文字:** 区別なし
